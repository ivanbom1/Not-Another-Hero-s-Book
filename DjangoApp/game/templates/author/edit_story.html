{% extends 'base.html' %}

{% block title %}Edit: {{ story.title }} - NAHB{% endblock %}

{% block content %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <h2>‚úèÔ∏è Edit: {{ story.title }}</h2>
    
    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}
    
    <form method="post" style="display: flex; flex-direction: column; gap: 1rem;">
        {% csrf_token %}
        
        <div>
            <label for="title">Title:</label>
            <input type="text" id="title" name="title" value="{{ story.title }}" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div>
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="4" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">{{ story.description }}</textarea>
        </div>
        
        <div>
            <label for="status">Status:</label>
            <select id="status" name="status" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="draft" {% if story.status == 'draft' %}selected{% endif %}>Draft</option>
                <option value="published" {% if story.status == 'published' %}selected{% endif %}>Published</option>
                <option value="suspended" {% if story.status == 'suspended' %}selected{% endif %}>Suspended</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-success">Save Changes</button>
    </form>
    
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd;">
        <h3>üìÑ Pages</h3>
        <a href="{% url 'add_page' story.id %}" class="btn">Add New Page</a>
        
        <div style="margin-top: 1.5rem;">
            {% if pages %}
                {% for page in pages %}
                    <div style="border: 1px solid #ddd; padding: 1.5rem; margin-bottom: 1rem; border-radius: 4px; background: #f9f9f9;">
                        <p><strong>Page {{ page.sequence }}{% if page.is_ending %} (Ending){% endif %}</strong></p>
                        <p style="margin: 0.5rem 0; color: #555;">{{ page.text|truncatewords:20 }}</p>
                        {% if page.ending_label %}
                            <p style="margin: 0.5rem 0; color: #27ae60;"><strong>Label:</strong> {{ page.ending_label }}</p>
                        {% endif %}
                        
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            {% if not page.is_ending %}
                                <a href="{% url 'add_choice' story.id page.id %}" class="btn" style="font-size: 0.9rem; padding: 0.5rem 1rem;">+ Add Choice</a>
                            {% endif %}
                            <form method="post" action="{% url 'delete_page' story.id page.id %}" style="display: inline;" onsubmit="return confirm('Delete this page and all its choices?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger" style="font-size: 0.9rem; padding: 0.5rem 1rem;">Delete Page</button>
                            </form>
                        </div>

                        {% if page.choices %}
                            <div style="margin-top: 1rem; background: white; padding: 1rem; border-radius: 4px;">
                                <strong>Choices:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    {% for choice in page.choices %}
                                        <li style="margin-bottom: 0.5rem;">
                                            {{ choice.text }} ‚Üí Page {{ choice.next_page_sequence }}
                                            <form method="post" action="{% url 'delete_choice' story.id page.id choice.id %}" style="display: inline;" onsubmit="return confirm('Delete this choice?');">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger" style="font-size: 0.8rem; padding: 0.25rem 0.75rem; margin-left: 0.5rem;">√ó</button>
                                            </form>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% else %}
                            <p style="margin-top: 1rem; color: #e74c3c;"><em>No choices yet</em></p>
                        {% endif %}
                        
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            {% if not page.is_ending %}
                                <a href="{% url 'add_choice' story.id page.id %}" class="btn" style="font-size: 0.9rem; padding: 0.5rem 1rem;">+ Add Choice</a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No pages yet. <a href="{% url 'add_page' story.id %}">Create the first page</a></p>
            {% endif %}
        </div>
    </div>
    
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd;">
        <h3>‚ö†Ô∏è Danger Zone</h3>
        <form method="post" action="{% url 'delete_story' story.id %}" style="display: inline;" onsubmit="return confirm('Are you sure? This cannot be undone.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Delete Story</button>
        </form>
    </div>
    
    <div style="margin-top: 2rem;">
        <a href="{% url 'stories_list' %}" class="btn">Back</a>
    </div>
</div>
{% endblock %}