{% extends 'base.html' %}

{% block title %}Edit: {{ story.title }} - NAHB{% endblock %}

{% block content %}
<div class="card" style="max-width: 850px; margin: 0 auto;">
    <h2>‚úèÔ∏è Edit: {{ story.title }}</h2>
    
    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}
    
    <form method="post" style="display: flex; flex-direction: column; gap: 1.5rem;">
        {% csrf_token %}
        
        <div>
            <label for="title">Story Title:</label>
            <input type="text" id="title" name="title" value="{{ story.title }}" required>
        </div>
        
        <div>
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="4" required>{{ story.description }}</textarea>
        </div>
        
        <div>
            <label for="status">Publication Status:</label>
            <select id="status" name="status">
                <option value="draft" {% if story.status == 'draft' %}selected{% endif %}>Draft (Private)</option>
                <option value="published" {% if story.status == 'published' %}selected{% endif %}>Published (Public)</option>
                {% if user.is_staff %}
                    <option value="suspended" {% if story.status == 'suspended' %}selected{% endif %}>Suspended (Admin Only)</option>
                {% endif %}
            </select>
        </div>  
        
        <button type="submit" class="btn btn-success">Save Changes</button>
    </form>
    
    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #8b4513;">
        <h3 style="color: #8b4513;">Story Pages</h3>
        <a href="{% url 'add_page' story.id %}" class="btn btn-success">+ Add New Page</a>
        
        <div style="margin-top: 2rem;">
            {% if pages %}
                {% for page in pages %}
                    <div style="border: 2px solid #8b4513; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 8px; background: linear-gradient(135deg, #f5e6d3 0%, #e8d7c3 100%);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <p style="font-size: 1.1rem; font-weight: bold; color: #3e2723;">Page {{ page.sequence }}{% if page.is_ending %}(Ending){% endif %}</p>
                                <p style="margin: 0.5rem 0; color: #555; line-height: 1.6;">{{ page.text|truncatewords:25 }}</p>
                                {% if page.ending_label %}
                                    <p style="margin: 0.5rem 0; color: #2d5016;"><strong>‚ú® Ending Label:</strong> {{ page.ending_label }}</p>
                                {% endif %}
                            </div>
                        </div>

                        {% if page.choices %}
                            <div style="margin-top: 1rem; background: linear-gradient(135deg, #faf5f0 0%, #f5e6d3 100%); padding: 1.2rem; border-radius: 4px; border-left: 3px solid #8b4513;">
                                <strong style="color: #3e2723;">‚öîÔ∏è Available Choices:</strong>
                                <ul style="margin: 0.8rem 0 0 1.8rem;">
                                    {% for choice in page.choices %}
                                        <li style="margin-bottom: 0.8rem; color: #333;">
                                            <span style="color: #8b4513; font-weight: bold;">{{ choice.text }}</span> ‚Üí <span style="color: #2d5016; font-weight: bold;">Page {{ choice.next_page_sequence }}</span>
                                            <form method="post" action="{% url 'delete_choice' story.id page.id choice.id %}" style="display: inline;" onsubmit="return confirm('Delete this choice?');">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-danger" style="font-size: 0.75rem; padding: 0.3rem 0.6rem; margin-left: 0.5rem;">√ó</button>
                                            </form>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% else %}
                            <p style="margin-top: 1rem; color: #666; font-style: italic;">No choices created yet.</p>
                        {% endif %}
                        
                        <div style="margin-top: 1.2rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            {% if not page.is_ending %}
                                <a href="{% url 'add_choice' story.id page.id %}" class="btn" style="font-size: 0.9rem; padding: 0.6rem 1rem;">+ Add Choice</a>
                            {% endif %}
                            <form method="post" action="{% url 'delete_page' story.id page.id %}" style="display: inline;" onsubmit="return confirm('Delete this page and all its choices? This cannot be undone.');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger" style="font-size: 0.9rem; padding: 0.6rem 1rem;">Delete Page</button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="color: #666; font-style: italic; padding: 2rem; text-align: center;">No pages yet. <a href="{% url 'add_page' story.id %}">Create the first page</a></p>
            {% endif %}
        </div>
    </div>
    
    <div style="margin-top: 3rem; padding: 2rem; background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%); border: 2px solid #a00; border-radius: 8px;">
        <h3 style="color: #a00;">Danger Zone</h3>
        <p style="color: #666; margin-bottom: 1rem;">Deleting a story is permanent and cannot be undone.</p>
        <form method="post" action="{% url 'delete_story' story.id %}" style="display: inline;" onsubmit="return confirm('Are you absolutely sure? This will permanently delete the story and all its pages and choices.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">üóëÔ∏è Delete Story Forever</button>
        </form>
    </div>
    
    <div style="margin-top: 2rem; text-align: center;">
        <a href="{% url 'stories_list' %}" class="btn">Back to Stories</a>
    </div>
</div>
{% endblock %}